<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Muestreo Faunístico — Calculadora</title>
  <meta name="color-scheme" content="light dark">
  <script>
    // Configuración de MathJax para TeX en línea y de bloque
    window.MathJax = {
      tex: {
        inlineMath: [['\\(','\\)'], ['$', '$']],
        displayMath: [['\\[','\\]'], ['$$','$$']]
      },
      options: { renderActions: { addMenu: [] } }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #1f2937;
      --muted: #6b7280;
      --card: #f8fafc;
      --border: #e5e7eb;
      --accent: #0ea5e9;
      --ok: #16a34a;
      --warn: #b45309;
      --err: #dc2626;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b1020;
        --fg: #e5e7eb;
        --muted: #9ca3af;
        --card: #0f172a;
        --border: #1f2937;
        --accent: #38bdf8;
        --ok: #22c55e;
        --warn: #f59e0b;
        --err: #ef4444;
      }
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg); color: var(--fg);
    }
    .container { max-width: 1000px; margin: 0 auto; padding: 24px; }
    header { display: flex; align-items: baseline; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    h1 { font-size: 1.6rem; margin: 0 0 4px 0; }
    .muted { color: var(--muted); font-size: 0.95rem; }
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 800px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .card h2 { margin: 0 0 10px 0; font-size: 1.1rem; }
    label { display: block; font-weight: 600; margin: 10px 0 6px; }
    input[type="number"], textarea { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--fg); }
    textarea { min-height: 120px; resize: vertical; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .row > div { flex: 1 1 160px; }
    button { appearance: none; border: 1px solid var(--accent); background: var(--accent); color: #001018; border-radius: 10px; padding: 10px 14px; font-weight: 700; cursor: pointer; }
    button.secondary { background: transparent; color: var(--accent); }
    .kvs { display: grid; grid-template-columns: 1fr auto; gap: 8px 12px; }
    .kvs div.key { color: var(--muted); }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); background: transparent; font-size: 0.85rem; }
    .pill.ok { border-color: var(--ok); color: var(--ok); }
    .pill.warn { border-color: var(--warn); color: var(--warn); }
    .pill.err { border-color: var(--err); color: var(--err); }
    .foot { margin-top: 20px; font-size: 0.9rem; color: var(--muted); }
    code { background: rgba(127,127,127,0.12); padding: 0 6px; border-radius: 6px; }
    .btns { display: flex; gap: 10px; flex-wrap: wrap; }
    .list { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .tag { border: 1px solid var(--border); border-radius: 999px; padding: 4px 8px; color: var(--muted); cursor: pointer; }
  </style>
  <script>
    function parseFrequencies(text) {
      const nums = (text || "")
        .replace(/\n/g, ' ')
        .split(/[;,\s]+/)
        .map(s => s.trim())
        .filter(Boolean)
        .map(Number)
        .filter(v => isFinite(v) && v > 0);
      return nums;
    }

    function roundTo(x, d) {
      const f = Math.pow(10, d);
      return Math.round((x + Number.EPSILON) * f) / f;
    }

    function linRegSlopeAndR2(x, y) {
      const n = x.length;
      const mean = arr => arr.reduce((a,b)=>a+b,0) / n;
      const mx = mean(x), my = mean(y);
      let sxx=0, syy=0, sxy=0;
      for (let i=0;i<n;i++) {
        const dx = x[i]-mx, dy = y[i]-my;
        sxx += dx*dx; syy += dy*dy; sxy += dx*dy;
      }
      const b = sxy / sxx; // pendiente
      const r2 = (sxy*sxy) / (sxx*syy || 1);
      const a0 = my - b*mx; // intercepto en ln-espacio
      return { a0, b, r2, mx, my };
    }

    function renderFitPlot(iArr, lnArr, a0, b) {
      const container = document.getElementById('plot');
      container.innerHTML = '';
      const W = 700, H = 380;
      const m = {left: 64, right: 16, top: 12, bottom: 42};
      const iw = W - m.left - m.right;
      const ih = H - m.top - m.bottom;

      const iMin = Math.min(...iArr);
      const iMax = Math.max(...iArr);
      const yMin = Math.min(...lnArr);
      const yMax = Math.max(...lnArr);
      const yPad = (yMax - yMin) * 0.08;
      const ymax = yMax + yPad;
      const ymin = yMin - yPad;

      const xScale = i => m.left + (i - iMin) / (iMax - iMin) * iw;
      const yScale = y => m.top + (ymax - y) / (ymax - ymin || 1) * ih;

      const svgNS = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
      svg.style.width = '100%';
      svg.style.height = 'auto';

      // Fondo opcional transparente

      // Ejes
      const axis = (x1,y1,x2,y2) => {
        const l = document.createElementNS(svgNS, 'line');
        l.setAttribute('x1', x1); l.setAttribute('y1', y1);
        l.setAttribute('x2', x2); l.setAttribute('y2', y2);
        l.setAttribute('stroke', 'var(--border)');
        l.setAttribute('stroke-width', '1');
        svg.appendChild(l);
      };
      // X axis
      axis(m.left, m.top + ih, m.left + iw, m.top + ih);
      // Y axis
      axis(m.left, m.top, m.left, m.top + ih);

      // Ticks Y
      const yticks = 5;
      for (let t = 0; t <= yticks; t++) {
        const yv = ymin + (t/yticks) * (ymax - ymin);
        const y = yScale(yv);
        const gl = document.createElementNS(svgNS, 'line');
        gl.setAttribute('x1', m.left); gl.setAttribute('y1', y);
        gl.setAttribute('x2', m.left + iw); gl.setAttribute('y2', y);
        gl.setAttribute('stroke', 'var(--border)'); gl.setAttribute('stroke-width', '1'); gl.setAttribute('opacity', '0.5');
        svg.appendChild(gl);
        const txt = document.createElementNS(svgNS, 'text');
        txt.setAttribute('x', m.left - 8); txt.setAttribute('y', y + 4);
        txt.setAttribute('text-anchor', 'end');
        txt.setAttribute('font-size', '12');
        txt.setAttribute('fill', 'var(--muted)');
        txt.textContent = (Math.round(yv*100)/100).toString();
        svg.appendChild(txt);
      }

      // Ticks X en enteros
      for (let k = iMin; k <= iMax; k++) {
        const x = xScale(k);
        const tl = document.createElementNS(svgNS, 'line');
        tl.setAttribute('x1', x); tl.setAttribute('y1', m.top + ih);
        tl.setAttribute('x2', x); tl.setAttribute('y2', m.top + ih + 6);
        tl.setAttribute('stroke', 'var(--border)');
        svg.appendChild(tl);
        const tx = document.createElementNS(svgNS, 'text');
        tx.setAttribute('x', x); tx.setAttribute('y', m.top + ih + 20);
        tx.setAttribute('text-anchor', 'middle'); tx.setAttribute('font-size', '12');
        tx.setAttribute('fill', 'var(--muted)');
        tx.textContent = String(k);
        svg.appendChild(tx);
      }

      // Etiquetas
      const xLabel = document.createElementNS(svgNS, 'text');
      xLabel.setAttribute('x', m.left + iw/2);
      xLabel.setAttribute('y', H - 8);
      xLabel.setAttribute('text-anchor', 'middle');
      xLabel.setAttribute('font-size', '12');
      xLabel.setAttribute('fill', 'var(--muted)');
      xLabel.textContent = 'i (especies de menor a mayor)';
      svg.appendChild(xLabel);

      const yLabel = document.createElementNS(svgNS, 'text');
      yLabel.setAttribute('transform', `translate(16 ${m.top + ih/2}) rotate(-90)`);
      yLabel.setAttribute('text-anchor', 'middle');
      yLabel.setAttribute('font-size', '12');
      yLabel.setAttribute('fill', 'var(--muted)');
      yLabel.textContent = 'ln(frecuencia)';
      svg.appendChild(yLabel);

      // Puntos
      for (let idx = 0; idx < iArr.length; idx++) {
        const cx = xScale(iArr[idx]);
        const cy = yScale(lnArr[idx]);
        const c = document.createElementNS(svgNS, 'circle');
        c.setAttribute('cx', cx); c.setAttribute('cy', cy); c.setAttribute('r', 4);
        c.setAttribute('fill', 'var(--accent)');
        c.setAttribute('opacity', '0.9');
        svg.appendChild(c);
      }

      // Recta ajustada: y = a0 + b*i
      const x1 = xScale(iMin), y1 = yScale(a0 + b * iMin);
      const x2 = xScale(iMax), y2 = yScale(a0 + b * iMax);
      const line = document.createElementNS(svgNS, 'line');
      line.setAttribute('x1', x1); line.setAttribute('y1', y1);
      line.setAttribute('x2', x2); line.setAttribute('y2', y2);
      line.setAttribute('stroke', 'var(--ok)');
      line.setAttribute('stroke-width', '2');
      svg.appendChild(line);

      container.appendChild(svg);
    }

    function calc() {
      const freqText = document.getElementById('freq').value;
      const PX = Number(document.getElementById('px').value);
      const d = Number(document.getElementById('dec').value);

      const xRaw = parseFrequencies(freqText);
      if (xRaw.length < 2) {
        alert('Introduce al menos 2 frecuencias (> 0).');
        return;
      }
      const x = [...xRaw].sort((a,b)=>a-b);
      const M = x.length;
      const N = x.reduce((a,b)=>a+b,0);
      const i = Array.from({length:M}, (_,k)=>k+1);
      const ln = x.map(v=>Math.log(v));

      const { a0, b, r2 } = linRegSlopeAndR2(i, ln);
      const W = Math.exp(b);
      const a_lin = Math.exp(a0); // para la curva esperada a*W^i en escala lineal

      // Validaciones básicas
      let issues = [];
      if (!(W > 1)) issues.push('W ≤ 1, ajuste no válido.');
      if (!(PX > 0 && PX < 1)) issues.push('P(X) debe estar entre 0 y 1.');
      if (issues.length) {
        alert(issues.join('\n'));
        return;
      }

      // Hipótesis A (J grande)
      const P = Math.pow(W, -M);
      const PX0 = Math.pow(1 - P, N);
      const X_pred = Math.log(PX) / Math.log(1 - P);
      const X_pred_round = Math.round(X_pred);
      const extraA = Math.max(0, X_pred_round - N);
      const rejetA = PX0 <= PX;

      // Hipótesis B (queda 1 especie)
      const denom = Math.pow(W, M+1) - 1;
      const P1 = (W - 1) / denom;
      const PX1 = Math.pow(1 - P1, N);
      const X1_pred = Math.log(PX) / Math.log(1 - P1);
      const X1_pred_round = Math.round(X1_pred);
      const extraB = Math.max(0, X1_pred_round - N);
      const rejetB = PX1 <= PX;

      // Escribe resultados
      const fmt = v => isFinite(v) ? String(roundTo(v, d)) : '—';
      document.getElementById('res-W').textContent = fmt(W);
      document.getElementById('res-b').textContent = fmt(b);
      document.getElementById('res-r2').textContent = fmt(r2);
      document.getElementById('res-M').textContent = M;
      document.getElementById('res-N').textContent = N;

      document.getElementById('res-P').textContent = fmt(P);
      document.getElementById('res-PX0').textContent = fmt(PX0);
      document.getElementById('res-X').textContent = isFinite(X_pred_round) ? X_pred_round : '—';
      document.getElementById('res-extraA').textContent = isFinite(extraA) ? extraA : '—';
      const pillA = document.getElementById('res-decisionA');
      pillA.textContent = rejetA ? 'H0 rechazada' : 'H0 no rechazada';
      pillA.className = 'pill ' + (rejetA ? 'ok' : 'warn');

      document.getElementById('res-P1').textContent = fmt(P1);
      document.getElementById('res-PX1').textContent = fmt(PX1);
      document.getElementById('res-X1').textContent = isFinite(X1_pred_round) ? X1_pred_round : '—';
      document.getElementById('res-extraB').textContent = isFinite(extraB) ? extraB : '—';
      const pillB = document.getElementById('res-decisionB');
      pillB.textContent = rejetB ? 'H2 rechazada' : 'H2 no rechazada';
      pillB.className = 'pill ' + (rejetB ? 'ok' : 'warn');

      // Gráfico ajuste ln(x) vs i
      renderFitPlot(i, ln, a0, b);

      // Estadísticos del ajuste ln: RMSE en ln-espacio
      const lnHat = i.map(k => a0 + b * k);
      const resLn = ln.map((v, idx) => v - lnHat[idx]);
      const rmseLn = Math.sqrt(resLn.reduce((s,e)=>s + e*e, 0) / M);
      document.getElementById('stat-W').textContent = fmt(W);
      document.getElementById('stat-b').textContent = fmt(b);
      document.getElementById('stat-R2').textContent = fmt(r2);
      document.getElementById('stat-RMSEln').textContent = fmt(rmseLn);
      let interpLn = '';
      if (W <= 1) interpLn = '\\(W \\le 1\\): el ajuste no es válido; recolecta más datos.';
      else if (r2 >= 0.9) interpLn = '\\(R^2\\) alto y \\(W>1\\): ajuste exponencial plausible.';
      else if (r2 >= 0.7) interpLn = '\\(R^2\\) moderado: usa los resultados con cautela.';
      else interpLn = '\\(R^2\\) bajo: el ajuste es pobre; recolecta más datos.';
      document.getElementById('interp-ln').textContent = interpLn;

      // Gráfico de frecuencias y curva esperada en escala lineal
      renderFreqPlot(i, x, a_lin, W);

      // Estadísticos en escala lineal
      const yhat = i.map(k => a_lin * Math.pow(W, k));
      const err = x.map((v, idx) => v - yhat[idx]);
      const mae = err.reduce((s,e)=>s + Math.abs(e), 0) / M;
      const rmse = Math.sqrt(err.reduce((s,e)=>s + e*e, 0) / M);
      const mape = x.reduce((s,v,idx)=> s + (v>0 ? Math.abs(err[idx]) / v : 0), 0) / M * 100;
      document.getElementById('stat-a').textContent = fmt(a_lin);
      document.getElementById('stat-MAE').textContent = fmt(mae);
      document.getElementById('stat-RMSE').textContent = fmt(rmse);
      document.getElementById('stat-MAPE').textContent = fmt(mape);

      // Intervalo de probabilidad (%) de que queden especies
      const fmtPct = v => isFinite(v) ? (String(roundTo(v*100, d)) + '%') : '—';
      const pmin = Math.min(PX0, PX1);
      const pmax = Math.max(PX0, PX1);
      const intervalText = (isFinite(pmin) && isFinite(pmax)) ? `${fmtPct(pmin)} – ${fmtPct(pmax)}` : '—';
      const intervalEl = document.getElementById('res-prob-interval');
      if (intervalEl) intervalEl.textContent = intervalText;

      // Interpretación textual
      let interpMsg = '';
      if (rejetA && rejetB) {
        interpMsg = 'Ambas hipótesis rechazadas: muestreo probablemente completo al nivel elegido.';
      } else if (rejetA && !rejetB) {
        const extraTxt = isFinite(extraB) ? ` Recolecta ≈ ${extraB} ejemplares más.` : '';
        interpMsg = 'H0 rechazada y H2 no rechazada: podría quedar 1 especie.' + extraTxt;
      } else {
        const extraTxt = isFinite(extraA) ? ` Recolecta ≈ ${extraA} ejemplares más.` : '';
        interpMsg = 'H0 no rechazada: probablemente queden especies.' + extraTxt;
      }
      const interpEl = document.getElementById('res-interpret');
      if (interpEl) interpEl.textContent = interpMsg;
      let interpFreq = '';
      if (!isFinite(mape)) interpFreq = 'No se pudo calcular MAPE (frecuencias no positivas).';
      else if (mape < 10) interpFreq = 'MAPE < 10%: muy buen ajuste de la curva a·W^i.';
      else if (mape < 20) interpFreq = 'MAPE 10–20%: ajuste razonable.';
      else interpFreq = 'MAPE ≥ 20%: ajuste pobre; considere más datos o revisar supuestos.';
      document.getElementById('interp-freq').textContent = interpFreq;

      // Guardar resultados actuales para exportación
      window.__lastResult = {
        input: { frecuencias: xRaw, PX, decimales: d },
        ajuste: { a0, b, W, R2: r2, RMSE_ln: rmseLn, M, N },
        hipotesisA: { P, PX0, X: X_pred_round, extra: extraA, rechazaH0: rejetA },
        hipotesisB: { P1, PX1, X1: X1_pred_round, extra: extraB, rechazaH2: rejetB },
        escala_lineal: { a: a_lin, MAE: mae, RMSE: rmse, MAPE: mape }
      };
      if (window.MathJax && MathJax.typesetPromise) { MathJax.typesetPromise(); }
    }

    function loadExample(n) {
      // Ejemplos del documento muestreo-faunistico.md
      // Ejemplo 1 (Liriomyza, Muestras 1–13): 1, 1, 17, 29, 104, 175 (X0 = 327)
      // Ejemplo 2 (Pomatoschistus microps): 2, 14, 56, 81, 158, 178, 551, 587, 1324 (X0 = 3521 en doc)
      let data = '';
      if (n === 1) {
        data = '1, 1, 17, 29, 104, 175';
      } else if (n === 2) {
        data = '2, 14, 56, 81, 158, 178, 551, 587, 1324';
      } else {
        data = '5, 3, 2, 1'; // fallback
      }
      document.getElementById('freq').value = data;
      document.getElementById('px').value = 0.1;
      document.getElementById('dec').value = 4;
      calc();
    }

    function renderFreqPlot(iArr, xArr, a, W) {
      const container = document.getElementById('plot2');
      container.innerHTML = '';
      const Wd = 700, Hd = 380;
      const m = {left: 64, right: 16, top: 12, bottom: 42};
      const iw = Wd - m.left - m.right; const ih = Hd - m.top - m.bottom;
      const xMin = 1, xMax = Math.max(...iArr);
      const yMax = Math.max(...xArr);
      const svgNS = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('viewBox', `0 0 ${Wd} ${Hd}`);
      svg.style.width = '100%';
      svg.style.height = 'auto';
      const xScale = v => m.left + (v - xMin) / (xMax - xMin) * iw;
      const yScale = v => m.top + (1 - v / (yMax || 1)) * ih;

      // Ejes
      const axis = (x1,y1,x2,y2) => {
        const l = document.createElementNS(svgNS, 'line');
        l.setAttribute('x1', x1); l.setAttribute('y1', y1);
        l.setAttribute('x2', x2); l.setAttribute('y2', y2);
        l.setAttribute('stroke', 'var(--border)');
        l.setAttribute('stroke-width', '1');
        svg.appendChild(l);
      };
      axis(m.left, m.top + ih, m.left + iw, m.top + ih);
      axis(m.left, m.top, m.left, m.top + ih);

      // Ticks X
      for (let k = xMin; k <= xMax; k++) {
        const x = xScale(k);
        const tl = document.createElementNS(svgNS, 'line');
        tl.setAttribute('x1', x); tl.setAttribute('y1', m.top + ih);
        tl.setAttribute('x2', x); tl.setAttribute('y2', m.top + ih + 6);
        tl.setAttribute('stroke', 'var(--border)'); svg.appendChild(tl);
        const tx = document.createElementNS(svgNS, 'text');
        tx.setAttribute('x', x); tx.setAttribute('y', m.top + ih + 20);
        tx.setAttribute('text-anchor', 'middle'); tx.setAttribute('font-size', '12');
        tx.setAttribute('fill', 'var(--muted)'); tx.textContent = String(k);
        svg.appendChild(tx);
      }
      // Ticks Y en 5 pasos
      const yticks = 5; const ymax = yMax;
      for (let t = 0; t <= yticks; t++) {
        const yv = (t/yticks) * ymax;
        const y = yScale(yv);
        const gl = document.createElementNS(svgNS, 'line');
        gl.setAttribute('x1', m.left); gl.setAttribute('y1', y);
        gl.setAttribute('x2', m.left + iw); gl.setAttribute('y2', y);
        gl.setAttribute('stroke', 'var(--border)'); gl.setAttribute('stroke-width', '1'); gl.setAttribute('opacity', '0.5');
        svg.appendChild(gl);
        const txt = document.createElementNS(svgNS, 'text');
        txt.setAttribute('x', m.left - 8); txt.setAttribute('y', y + 4); txt.setAttribute('text-anchor', 'end');
        txt.setAttribute('font-size', '12'); txt.setAttribute('fill', 'var(--muted)'); txt.textContent = String(Math.round(yv*100)/100);
        svg.appendChild(txt);
      }

      // Etiquetas
      const xLabel = document.createElementNS(svgNS, 'text');
      xLabel.setAttribute('x', m.left + iw/2); xLabel.setAttribute('y', Hd - 8);
      xLabel.setAttribute('text-anchor', 'middle'); xLabel.setAttribute('font-size', '12'); xLabel.setAttribute('fill', 'var(--muted)');
      xLabel.textContent = 'i (especies de menor a mayor)'; svg.appendChild(xLabel);
      const yLabel = document.createElementNS(svgNS, 'text');
      yLabel.setAttribute('transform', `translate(16 ${m.top + ih/2}) rotate(-90)`);
      yLabel.setAttribute('text-anchor', 'middle'); yLabel.setAttribute('font-size', '12'); yLabel.setAttribute('fill', 'var(--muted)');
      yLabel.textContent = 'frecuencia'; svg.appendChild(yLabel);

      // Puntos observados
      for (let idx = 0; idx < iArr.length; idx++) {
        const cx = xScale(iArr[idx]); const cy = yScale(xArr[idx]);
        const c = document.createElementNS(svgNS, 'circle');
        c.setAttribute('cx', cx); c.setAttribute('cy', cy); c.setAttribute('r', 4);
        c.setAttribute('fill', 'var(--accent)'); c.setAttribute('opacity', '0.9');
        svg.appendChild(c);
      }
      // Curva esperada y = a*W^i
      const path = document.createElementNS(svgNS, 'path');
      let d = '';
      for (let k = xMin; k <= xMax; k++) {
        const yhat = a * Math.pow(W, k);
        const X = xScale(k), Y = yScale(yhat);
        d += (k === xMin ? 'M' : 'L') + X + ' ' + Y + ' ';
      }
      path.setAttribute('d', d.trim()); path.setAttribute('fill', 'none');
      path.setAttribute('stroke', 'var(--ok)'); path.setAttribute('stroke-width', '2');
      svg.appendChild(path);

      container.appendChild(svg);
    }

    function download(filename, text) {
      const a = document.createElement('a');
      a.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      a.setAttribute('download', filename);
      a.style.display = 'none'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function exportJSON() {
      if (!window.__lastResult) { alert('Primero calcula resultados.'); return; }
      download('muestreo_resultados.json', JSON.stringify(window.__lastResult, null, 2));
    }

    function exportCSV() {
      if (!window.__lastResult) { alert('Primero calcula resultados.'); return; }
      const r = window.__lastResult;
      const lines = [];
      lines.push('clave,valor');
      lines.push(`M,${r.ajuste.M}`);
      lines.push(`N,${r.ajuste.N}`);
      lines.push(`b,${r.ajuste.b}`);
      lines.push(`W,${r.ajuste.W}`);
      lines.push(`R2,${r.ajuste.R2}`);
      lines.push(`P,${r.hipotesisA.P}`);
      lines.push(`PX0,${r.hipotesisA.PX0}`);
      lines.push(`X,${r.hipotesisA.X}`);
      lines.push(`extraA,${r.hipotesisA.extra}`);
      lines.push(`rechazaH0,${r.hipotesisA.rechazaH0}`);
      lines.push(`P1,${r.hipotesisB.P1}`);
      lines.push(`PX1,${r.hipotesisB.PX1}`);
      lines.push(`X1,${r.hipotesisB.X1}`);
      lines.push(`extraB,${r.hipotesisB.extra}`);
      lines.push(`rechazaH2,${r.hipotesisB.rechazaH2}`);
      download('muestreo_resultados.csv', lines.join('\n'));
    }

    function exportPDF() {
      if (!window.__lastResult) { alert('Primero calcula resultados.'); return; }
      const r = window.__lastResult;
      const d = r.input.decimales ?? 4;
      const fmt = v => isFinite(v) ? String(roundTo(v, d)) : '—';
      const fmtPct = v => isFinite(v) ? (String(roundTo(v*100, d)) + '%') : '—';
      const freqs = (r.input.frecuencias || []).slice();
      const svg1 = document.getElementById('plot')?.querySelector('svg');
      const svg2 = document.getElementById('plot2')?.querySelector('svg');
      const svg1html = svg1 ? svg1.outerHTML : '';
      const svg2html = svg2 ? svg2.outerHTML : '';

      const pmin = Math.min(r.hipotesisA.PX0, r.hipotesisB.PX1);
      const pmax = Math.max(r.hipotesisA.PX0, r.hipotesisB.PX1);
      const intervalo = (isFinite(pmin) && isFinite(pmax)) ? `${fmtPct(pmin)} – ${fmtPct(pmax)}` : '—';
      let interpMsg = '';
      if (r.hipotesisA.rechazaH0 && r.hipotesisB.rechazaH2) interpMsg = 'Ambas hipótesis rechazadas: muestreo probablemente completo al nivel elegido.';
      else if (r.hipotesisA.rechazaH0 && !r.hipotesisB.rechazaH2) interpMsg = `H0 rechazada y H2 no rechazada: podría quedar 1 especie. Recolecta ≈ ${r.hipotesisB.extra} ejemplares más.`;
      else interpMsg = `H0 no rechazada: probablemente queden especies. Recolecta ≈ ${r.hipotesisA.extra} ejemplares más.`;

      const now = new Date();
      const fecha = now.toLocaleString();

      const html = `<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Informe — Muestreo Faunístico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#000; --muted:#555; --border:#ccc; --accent:#0ea5e9; --ok:#16a34a; }
    html, body { margin:0; padding:0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Helvetica, Arial; color: var(--fg); }
    .wrap { max-width: 900px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 1.6rem; margin: 0 0 4px 0; }
    h2 { font-size: 1.15rem; margin: 18px 0 8px; }
    .muted { color: var(--muted); }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 8px 10px; border-bottom: 1px solid var(--border); }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    .cols { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .box { border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
    .kvs { display: grid; grid-template-columns: 1fr auto; gap: 8px 12px; }
    .kvs .key { color: var(--muted); }
    figure { margin: 12px 0; page-break-inside: avoid; }
    svg { width: 100%; height: auto; }
    @media print {
      .no-print { display: none; }
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Informe — Muestreo Faunístico</h1>
    <div class="muted">Generado: ${fecha}</div>

    <h2>Entrada</h2>
    <div class="box">
      <div class="kvs">
        <div class="key">Frecuencias (orden dadas)</div><div>${freqs.join(', ')}</div>
        <div class="key">P(X) objetivo</div><div>${(r.input.PX !== undefined ? r.input.PX : '—')}</div>
        <div class="key">Decimales</div><div>${d}</div>
      </div>
    </div>

    <div class="cols">
      <div class="box">
        <h2>Datos y ajuste</h2>
        <div class="kvs">
          <div class="key">M (nº de especies)</div><div>${r.ajuste.M}</div>
          <div class="key">N (total ejemplares)</div><div>${r.ajuste.N}</div>
          <div class="key">b (pendiente ln)</div><div>${fmt(r.ajuste.b)}</div>
          <div class="key">W = e^b</div><div>${fmt(r.ajuste.W)}</div>
          <div class="key">R^2 (ln)</div><div>${fmt(r.ajuste.R2)}</div>
          <div class="key">RMSE ln</div><div>${fmt(r.ajuste.RMSE_ln)}</div>
        </div>
      </div>
      <div class="box">
        <h2>Escala lineal</h2>
        <div class="kvs">
          <div class="key">a = e^{a0}</div><div>${fmt(r.escala_lineal.a)}</div>
          <div class="key">MAE</div><div>${fmt(r.escala_lineal.MAE)}</div>
          <div class="key">RMSE</div><div>${fmt(r.escala_lineal.RMSE)}</div>
          <div class="key">MAPE (%)</div><div>${fmt(r.escala_lineal.MAPE)}</div>
        </div>
      </div>
    </div>

    <div class="cols">
      <div class="box">
        <h2>Hipótesis A — J grande</h2>
        <div class="kvs">
          <div class="key">P ≈ 1/W^M</div><div>${fmt(r.hipotesisA.P)}</div>
          <div class="key">P(X0) = (1−P)^N</div><div>${fmt(r.hipotesisA.PX0)} (${fmtPct(r.hipotesisA.PX0)})</div>
          <div class="key">X predicho</div><div>${r.hipotesisA.X}</div>
          <div class="key">Ejemplares suplementarios</div><div>${r.hipotesisA.extra}</div>
          <div class="key">Decisión</div><div>${r.hipotesisA.rechazaH0 ? 'H0 rechazada' : 'H0 no rechazada'}</div>
        </div>
      </div>
      <div class="box">
        <h2>Hipótesis B — queda 1 especie</h2>
        <div class="kvs">
          <div class="key">P(1) = (W−1)/(W^{M+1}−1)</div><div>${fmt(r.hipotesisB.P1)}</div>
          <div class="key">P'(X0) = (1−P(1))^N</div><div>${fmt(r.hipotesisB.PX1)} (${fmtPct(r.hipotesisB.PX1)})</div>
          <div class="key">X predicho</div><div>${r.hipotesisB.X1}</div>
          <div class="key">Ejemplares suplementarios</div><div>${r.hipotesisB.extra}</div>
          <div class="key">Decisión</div><div>${r.hipotesisB.rechazaH2 ? 'H2 rechazada' : 'H2 no rechazada'}</div>
        </div>
      </div>
    </div>

    <div class="box">
      <h2>Probabilidad de que queden especies</h2>
      <div class="kvs">
        <div class="key">Intervalo estimado (%)</div><div>${intervalo}</div>
      </div>
      <div class="muted">${interpMsg}</div>
    </div>

    <div class="grid">
      <div class="box">
        <h2>Gráfico ln(x) vs i</h2>
        <figure>${svg1html}</figure>
      </div>
      <div class="box">
        <h2>Frecuencias y curva esperada</h2>
        <figure>${svg2html}</figure>
      </div>
    </div>

  </div>
  <script>
    window.addEventListener('load', () => { setTimeout(() => { window.print(); }, 200); });
  <\/script>
</body>
</html>`;

      const win = window.open('', '_blank');
      if (!win) { alert('El bloqueador de ventanas impide abrir el informe.'); return; }
      win.document.open();
      win.document.write(html);
      win.document.close();
    }

    function listDatasets() {
      const keys = Object.keys(localStorage).filter(k => k.startsWith('dataset:')).map(k => k.slice(8));
      const wrap = document.getElementById('datasets');
      wrap.innerHTML = '';
      keys.sort().forEach(name => {
        const el = document.createElement('span');
        el.className = 'tag'; el.textContent = name;
        el.title = 'Click para cargar';
        el.onclick = () => loadDataset(name);
        wrap.appendChild(el);
      });
    }

    function saveDataset() {
      const name = prompt('Nombre del dataset');
      if (!name) return;
      const freqText = document.getElementById('freq').value;
      localStorage.setItem('dataset:' + name, freqText);
      listDatasets();
    }

    function loadDataset(name) {
      const key = 'dataset:' + (name || prompt('Nombre a cargar'));
      const data = localStorage.getItem(key);
      if (!data) { alert('No existe ese dataset.'); return; }
      document.getElementById('freq').value = data;
      calc();
    }

    window.addEventListener('DOMContentLoaded', listDatasets);
  </script>
  </head>
  <body>
    <div class="container">
      <header>
        <div>
          <h1>Muestreo Faunístico — Calculadora</h1>
        </div>
        <div class="btns">
          <button class="secondary" title="Liriomyza, M=6, X0=327" onclick="loadExample(1)">Ejemplo 1</button>
          <button class="secondary" title="P. microps, M=9, X0=3521" onclick="loadExample(2)">Ejemplo 2</button>
        </div>
      </header>

      <div class="grid" style="margin-top:16px;">
        <div class="card">
          <h2>Entrada</h2>
          <label for="freq">Frecuencias por especie (absolutas o relativas)</label>
          <textarea id="freq" placeholder="Ej: 5, 3, 2, 1 o 5 3 2 1"></textarea>
          <div class="row">
            <div>
              <label for="px">P(X) objetivo (error tipo I)</label>
              <input type="number" id="px" min="0.0001" max="0.5" step="0.001" value="0.1">
            </div>
            <div>
              <label for="dec">Decimales</label>
              <input type="number" id="dec" min="0" max="10" step="1" value="4">
            </div>
          </div>
          <div style="margin-top:12px;" class="btns">
            <button onclick="calc()">Calcular</button>
            <button class="secondary" onclick="exportJSON()">Exportar JSON</button>
            <button class="secondary" onclick="exportCSV()">Exportar CSV</button>
            <button class="secondary" onclick="exportPDF()">Informe PDF</button>
            <button class="secondary" onclick="saveDataset()">Guardar dataset</button>
          </div>
          <div class="list" id="datasets" aria-label="Datasets guardados"></div>
          <div class="foot">Las frecuencias se ordenan de menor a mayor. Se calcula \(W = e^{b}\) ajustando \(\ln(x)\) contra \(i = 1..M\).</div>
        </div>

        <div class="card">
          <h2>Datos y ajuste</h2>
          <div class="kvs">
            <div class="key">Número de especies (M)</div><div id="res-M">—</div>
            <div class="key">Total de ejemplares (N)</div><div id="res-N">—</div>
            <div class="key">Pendiente \((b)\)</div><div id="res-b">—</div>
            <div class="key">\(W = e^{b}\)</div><div id="res-W">—</div>
            <div class="key">\(R^2\) (ajuste exponencial)</div><div id="res-r2">—</div>
          </div>
        </div>
      </div>

      <div class="grid" style="margin-top:16px;">
        <div class="card">
          <h2>Hipótesis A — \(J\) grande</h2>
          <div class="kvs">
            <div class="key">\(P \approx \dfrac{1}{W^{M}}\)</div><div id="res-P">—</div>
            <div class="key">\(P(X_0) = (1-P)^{N}\)</div><div id="res-PX0">—</div>
            <div class="key">X predicho</div><div id="res-X">—</div>
            <div class="key">Ejemplares suplementarios</div><div id="res-extraA">—</div>
            <div class="key">Decisión</div><div id="res-decisionA" class="pill">—</div>
          </div>
          <div class="foot">Rechaza \(H_0\) si \(P(X_0) \le P(X)\).</div>
        </div>

        <div class="card">
          <h2>Hipótesis B — queda 1 especie</h2>
          <div class="kvs">
            <div class="key">\(P(1) = \dfrac{W-1}{W^{M+1}-1}\)</div><div id="res-P1">—</div>
            <div class="key">\(P'(X_0) = (1-P(1))^{N}\)</div><div id="res-PX1">—</div>
            <div class="key">X predicho</div><div id="res-X1">—</div>
            <div class="key">Ejemplares suplementarios</div><div id="res-extraB">—</div>
            <div class="key">Decisión</div><div id="res-decisionB" class="pill">—</div>
          </div>
          <div class="foot">Rechaza \(H_2\) si \(P'(X_0) \le P(X)\).</div>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h2>Probabilidad de que queden especies</h2>
        <div class="kvs">
          <div class="key">Intervalo estimado (%)</div><div id="res-prob-interval">—</div>
        </div>
        <div class="foot">Basado en \(P(X_0)\) y \(P'(X_0)\) del método.</div>
        <div class="foot" id="res-interpret">—</div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h2>Gráfico del ajuste ln(x) vs i</h2>
        <div id="plot"></div>
        <div class="foot">Puntos: ln(frecuencia) por especie; línea: regresión \(\ln(x) = a + b\,i\).</div>
        <div style="margin-top:12px;">
          <div class="kvs">
            <div class="key">\(W = e^{b}\)</div><div id="stat-W">—</div>
            <div class="key">Pendiente \((b)\)</div><div id="stat-b">—</div>
            <div class="key" title="Coeficiente de determinación del ajuste lineal en ln-espacio (0–1)">\(R^2\)</div><div id="stat-R2">—</div>
            <div class="key" title="Raíz del error cuadrático medio en ln-espacio; menor es mejor">RMSE ln</div><div id="stat-RMSEln">—</div>
          </div>
          <div class="foot" id="interp-ln">—</div>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h2>Frecuencias y curva esperada</h2>
        <div id="plot2"></div>
        <div class="foot">Puntos: frecuencia observada; curva: \(a\,W^{i}\) estimada desde el ajuste (escala lineal).</div>
        <div style="margin-top:12px;">
          <div class="kvs">
            <div class="key">\(a = e^{a_0}\)</div><div id="stat-a">—</div>
            <div class="key" title="Media del error absoluto; menor es mejor">MAE</div><div id="stat-MAE">—</div>
            <div class="key" title="Raíz del error cuadrático medio; penaliza errores grandes">RMSE</div><div id="stat-RMSE">—</div>
            <div class="key" title="Error porcentual absoluto medio; si hay x_i=0 no se calcula">MAPE (%)</div><div id="stat-MAPE">—</div>
      </div>
      <div class="foot" id="interp-freq">—</div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h2>Ayuda de métricas</h2>
    <div class="foot">
      \(\displaystyle \textbf{MAE}=\frac{1}{M}\sum_i |x_i-\hat y_i|\) — unidades: individuos; menor es mejor.
    </div>
    <div class="foot">
      \(\displaystyle \textbf{RMSE}=\sqrt{\frac{1}{M}\sum_i (x_i-\hat y_i)^2}\) — unidades: individuos; penaliza errores grandes.
    </div>
    <div class="foot">
      \(\displaystyle \textbf{MAPE}=\frac{100}{M}\sum_i \frac{|x_i-\hat y_i|}{x_i}\) — porcentaje; no se calcula si existe \(x_i=0\).
    </div>
    <div class="foot">
      \(\displaystyle \textbf{RMSE\ ln}=\sqrt{\frac{1}{M}\sum_i (\ln x_i - (a_0 + b\,i))^2}\) — evalúa la linealidad en \(\ln\)-espacio; menor es mejor.
    </div>
    <div class="foot">
      \(\textbf{R}^2\) — calidad del ajuste lineal en \(\ln\)-espacio (0–1); cercano a 1 indica buen ajuste.
    </div>
  </div>
      <p class="foot">Notas: Usa logaritmo neperiano. Si \(W \le 1\), el ajuste exponencial no es válido. Las fórmulas siguen el documento “muestreo-faunistico.md”.</p>
    </div>
  </body>
  </html>
