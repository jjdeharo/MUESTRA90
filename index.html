<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Muestreo Faunístico — Calculadora</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root {
      --bg: #ffffff;
      --fg: #1f2937;
      --muted: #6b7280;
      --card: #f8fafc;
      --border: #e5e7eb;
      --accent: #0ea5e9;
      --ok: #16a34a;
      --warn: #b45309;
      --err: #dc2626;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b1020;
        --fg: #e5e7eb;
        --muted: #9ca3af;
        --card: #0f172a;
        --border: #1f2937;
        --accent: #38bdf8;
        --ok: #22c55e;
        --warn: #f59e0b;
        --err: #ef4444;
      }
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg); color: var(--fg);
    }
    .container { max-width: 1000px; margin: 0 auto; padding: 24px; }
    header { display: flex; align-items: baseline; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    h1 { font-size: 1.6rem; margin: 0 0 4px 0; }
    .muted { color: var(--muted); font-size: 0.95rem; }
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 800px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .card h2 { margin: 0 0 10px 0; font-size: 1.1rem; }
    label { display: block; font-weight: 600; margin: 10px 0 6px; }
    input[type="number"], textarea { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--fg); }
    textarea { min-height: 120px; resize: vertical; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .row > div { flex: 1 1 160px; }
    button { appearance: none; border: 1px solid var(--accent); background: var(--accent); color: #001018; border-radius: 10px; padding: 10px 14px; font-weight: 700; cursor: pointer; }
    button.secondary { background: transparent; color: var(--accent); }
    .kvs { display: grid; grid-template-columns: 1fr auto; gap: 8px 12px; }
    .kvs div.key { color: var(--muted); }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); background: transparent; font-size: 0.85rem; }
    .pill.ok { border-color: var(--ok); color: var(--ok); }
    .pill.warn { border-color: var(--warn); color: var(--warn); }
    .pill.err { border-color: var(--err); color: var(--err); }
    .foot { margin-top: 20px; font-size: 0.9rem; color: var(--muted); }
    code { background: rgba(127,127,127,0.12); padding: 0 6px; border-radius: 6px; }
  </style>
  <script>
    function parseFrequencies(text) {
      const nums = (text || "")
        .replace(/\n/g, ' ')
        .split(/[;,\s]+/)
        .map(s => s.trim())
        .filter(Boolean)
        .map(Number)
        .filter(v => isFinite(v) && v > 0);
      return nums;
    }

    function roundTo(x, d) {
      const f = Math.pow(10, d);
      return Math.round((x + Number.EPSILON) * f) / f;
    }

    function linRegSlopeAndR2(x, y) {
      const n = x.length;
      const mean = arr => arr.reduce((a,b)=>a+b,0) / n;
      const mx = mean(x), my = mean(y);
      let sxx=0, syy=0, sxy=0;
      for (let i=0;i<n;i++) {
        const dx = x[i]-mx, dy = y[i]-my;
        sxx += dx*dx; syy += dy*dy; sxy += dx*dy;
      }
      const b = sxy / sxx; // pendiente
      const r2 = (sxy*sxy) / (sxx*syy || 1);
      const a0 = my - b*mx; // intercepto en ln-espacio
      return { a0, b, r2, mx, my };
    }

    function renderFitPlot(iArr, lnArr, a0, b) {
      const container = document.getElementById('plot');
      container.innerHTML = '';
      const W = 700, H = 380;
      const m = {left: 64, right: 16, top: 12, bottom: 42};
      const iw = W - m.left - m.right;
      const ih = H - m.top - m.bottom;

      const iMin = Math.min(...iArr);
      const iMax = Math.max(...iArr);
      const yMin = Math.min(...lnArr);
      const yMax = Math.max(...lnArr);
      const yPad = (yMax - yMin) * 0.08;
      const ymax = yMax + yPad;
      const ymin = yMin - yPad;

      const xScale = i => m.left + (i - iMin) / (iMax - iMin) * iw;
      const yScale = y => m.top + (ymax - y) / (ymax - ymin || 1) * ih;

      const svgNS = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
      svg.style.width = '100%';
      svg.style.height = 'auto';

      // Fondo opcional transparente

      // Ejes
      const axis = (x1,y1,x2,y2) => {
        const l = document.createElementNS(svgNS, 'line');
        l.setAttribute('x1', x1); l.setAttribute('y1', y1);
        l.setAttribute('x2', x2); l.setAttribute('y2', y2);
        l.setAttribute('stroke', 'var(--border)');
        l.setAttribute('stroke-width', '1');
        svg.appendChild(l);
      };
      // X axis
      axis(m.left, m.top + ih, m.left + iw, m.top + ih);
      // Y axis
      axis(m.left, m.top, m.left, m.top + ih);

      // Ticks Y
      const yticks = 5;
      for (let t = 0; t <= yticks; t++) {
        const yv = ymin + (t/yticks) * (ymax - ymin);
        const y = yScale(yv);
        const gl = document.createElementNS(svgNS, 'line');
        gl.setAttribute('x1', m.left); gl.setAttribute('y1', y);
        gl.setAttribute('x2', m.left + iw); gl.setAttribute('y2', y);
        gl.setAttribute('stroke', 'var(--border)'); gl.setAttribute('stroke-width', '1'); gl.setAttribute('opacity', '0.5');
        svg.appendChild(gl);
        const txt = document.createElementNS(svgNS, 'text');
        txt.setAttribute('x', m.left - 8); txt.setAttribute('y', y + 4);
        txt.setAttribute('text-anchor', 'end');
        txt.setAttribute('font-size', '12');
        txt.setAttribute('fill', 'var(--muted)');
        txt.textContent = (Math.round(yv*100)/100).toString();
        svg.appendChild(txt);
      }

      // Ticks X en enteros
      for (let k = iMin; k <= iMax; k++) {
        const x = xScale(k);
        const tl = document.createElementNS(svgNS, 'line');
        tl.setAttribute('x1', x); tl.setAttribute('y1', m.top + ih);
        tl.setAttribute('x2', x); tl.setAttribute('y2', m.top + ih + 6);
        tl.setAttribute('stroke', 'var(--border)');
        svg.appendChild(tl);
        const tx = document.createElementNS(svgNS, 'text');
        tx.setAttribute('x', x); tx.setAttribute('y', m.top + ih + 20);
        tx.setAttribute('text-anchor', 'middle'); tx.setAttribute('font-size', '12');
        tx.setAttribute('fill', 'var(--muted)');
        tx.textContent = String(k);
        svg.appendChild(tx);
      }

      // Etiquetas
      const xLabel = document.createElementNS(svgNS, 'text');
      xLabel.setAttribute('x', m.left + iw/2);
      xLabel.setAttribute('y', H - 8);
      xLabel.setAttribute('text-anchor', 'middle');
      xLabel.setAttribute('font-size', '12');
      xLabel.setAttribute('fill', 'var(--muted)');
      xLabel.textContent = 'i (especies de menor a mayor)';
      svg.appendChild(xLabel);

      const yLabel = document.createElementNS(svgNS, 'text');
      yLabel.setAttribute('transform', `translate(16 ${m.top + ih/2}) rotate(-90)`);
      yLabel.setAttribute('text-anchor', 'middle');
      yLabel.setAttribute('font-size', '12');
      yLabel.setAttribute('fill', 'var(--muted)');
      yLabel.textContent = 'ln(frecuencia)';
      svg.appendChild(yLabel);

      // Puntos
      for (let idx = 0; idx < iArr.length; idx++) {
        const cx = xScale(iArr[idx]);
        const cy = yScale(lnArr[idx]);
        const c = document.createElementNS(svgNS, 'circle');
        c.setAttribute('cx', cx); c.setAttribute('cy', cy); c.setAttribute('r', 4);
        c.setAttribute('fill', 'var(--accent)');
        c.setAttribute('opacity', '0.9');
        svg.appendChild(c);
      }

      // Recta ajustada: y = a0 + b*i
      const x1 = xScale(iMin), y1 = yScale(a0 + b * iMin);
      const x2 = xScale(iMax), y2 = yScale(a0 + b * iMax);
      const line = document.createElementNS(svgNS, 'line');
      line.setAttribute('x1', x1); line.setAttribute('y1', y1);
      line.setAttribute('x2', x2); line.setAttribute('y2', y2);
      line.setAttribute('stroke', 'var(--ok)');
      line.setAttribute('stroke-width', '2');
      svg.appendChild(line);

      container.appendChild(svg);
    }

    function calc() {
      const freqText = document.getElementById('freq').value;
      const PX = Number(document.getElementById('px').value);
      const d = Number(document.getElementById('dec').value);

      const xRaw = parseFrequencies(freqText);
      if (xRaw.length < 2) {
        alert('Introduce al menos 2 frecuencias (> 0).');
        return;
      }
      const x = [...xRaw].sort((a,b)=>a-b);
      const M = x.length;
      const N = x.reduce((a,b)=>a+b,0);
      const i = Array.from({length:M}, (_,k)=>k+1);
      const ln = x.map(v=>Math.log(v));

      const { a0, b, r2 } = linRegSlopeAndR2(i, ln);
      const W = Math.exp(b);

      // Validaciones básicas
      let issues = [];
      if (!(W > 1)) issues.push('W ≤ 1, ajuste no válido.');
      if (!(PX > 0 && PX < 1)) issues.push('P(X) debe estar entre 0 y 1.');
      if (issues.length) {
        alert(issues.join('\n'));
        return;
      }

      // Hipótesis A (J grande)
      const P = Math.pow(W, -M);
      const PX0 = Math.pow(1 - P, N);
      const X_pred = Math.log(PX) / Math.log(1 - P);
      const X_pred_round = Math.round(X_pred);
      const extraA = Math.max(0, X_pred_round - N);
      const rejetA = PX0 <= PX;

      // Hipótesis B (queda 1 especie)
      const denom = Math.pow(W, M+1) - 1;
      const P1 = (W - 1) / denom;
      const PX1 = Math.pow(1 - P1, N);
      const X1_pred = Math.log(PX) / Math.log(1 - P1);
      const X1_pred_round = Math.round(X1_pred);
      const extraB = Math.max(0, X1_pred_round - N);
      const rejetB = PX1 <= PX;

      // Escribe resultados
      const fmt = v => isFinite(v) ? String(roundTo(v, d)) : '—';
      document.getElementById('res-W').textContent = fmt(W);
      document.getElementById('res-b').textContent = fmt(b);
      document.getElementById('res-r2').textContent = fmt(r2);
      document.getElementById('res-M').textContent = M;
      document.getElementById('res-N').textContent = N;

      document.getElementById('res-P').textContent = fmt(P);
      document.getElementById('res-PX0').textContent = fmt(PX0);
      document.getElementById('res-X').textContent = isFinite(X_pred_round) ? X_pred_round : '—';
      document.getElementById('res-extraA').textContent = isFinite(extraA) ? extraA : '—';
      const pillA = document.getElementById('res-decisionA');
      pillA.textContent = rejetA ? 'H0 rechazada' : 'H0 no rechazada';
      pillA.className = 'pill ' + (rejetA ? 'ok' : 'warn');

      document.getElementById('res-P1').textContent = fmt(P1);
      document.getElementById('res-PX1').textContent = fmt(PX1);
      document.getElementById('res-X1').textContent = isFinite(X1_pred_round) ? X1_pred_round : '—';
      document.getElementById('res-extraB').textContent = isFinite(extraB) ? extraB : '—';
      const pillB = document.getElementById('res-decisionB');
      pillB.textContent = rejetB ? 'H2 rechazada' : 'H2 no rechazada';
      pillB.className = 'pill ' + (rejetB ? 'ok' : 'warn');

      // Gráfico ajuste ln(x) vs i
      renderFitPlot(i, ln, a0, b);
    }

    function loadExample() {
      // Ejemplo simple
      document.getElementById('freq').value = '5, 3, 2, 1';
      document.getElementById('px').value = 0.1;
      document.getElementById('dec').value = 4;
      calc();
    }
  </script>
  </head>
  <body>
    <div class="container">
      <header>
        <div>
          <h1>Muestreo Faunístico — Calculadora</h1>
          <div class="muted">Implementa las fórmulas del documento y del script <code>muestreo.R</code>.</div>
        </div>
        <div>
          <button class="secondary" onclick="loadExample()">Cargar ejemplo</button>
        </div>
      </header>

      <div class="grid" style="margin-top:16px;">
        <div class="card">
          <h2>Entrada</h2>
          <label for="freq">Frecuencias por especie (absolutas o relativas)</label>
          <textarea id="freq" placeholder="Ej: 5, 3, 2, 1 o 5 3 2 1"></textarea>
          <div class="row">
            <div>
              <label for="px">P(X) objetivo (error tipo I)</label>
              <input type="number" id="px" min="0.0001" max="0.5" step="0.001" value="0.1">
            </div>
            <div>
              <label for="dec">Decimales</label>
              <input type="number" id="dec" min="0" max="10" step="1" value="4">
            </div>
          </div>
          <div style="margin-top:12px; display:flex; gap:10px;">
            <button onclick="calc()">Calcular</button>
          </div>
          <div class="foot">Las frecuencias se ordenan de menor a mayor. Se calcula <code>W = e^b</code> ajustando <code>ln(x)</code> contra <code>i = 1..M</code>.</div>
        </div>

        <div class="card">
          <h2>Datos y ajuste</h2>
          <div class="kvs">
            <div class="key">Número de especies (M)</div><div id="res-M">—</div>
            <div class="key">Total de ejemplares (N)</div><div id="res-N">—</div>
            <div class="key">Pendiente (b)</div><div id="res-b">—</div>
            <div class="key">W = e^b</div><div id="res-W">—</div>
            <div class="key">R² (ajuste exponencial)</div><div id="res-r2">—</div>
          </div>
        </div>
      </div>

      <div class="grid" style="margin-top:16px;">
        <div class="card">
          <h2>Hipótesis A — J grande</h2>
          <div class="kvs">
            <div class="key">P ≈ 1/W^M</div><div id="res-P">—</div>
            <div class="key">P(X₀) = (1−P)^N</div><div id="res-PX0">—</div>
            <div class="key">X predicho</div><div id="res-X">—</div>
            <div class="key">Ejemplares suplementarios</div><div id="res-extraA">—</div>
            <div class="key">Decisión</div><div id="res-decisionA" class="pill">—</div>
          </div>
          <div class="foot">Rechaza H0 si P(X₀) ≤ P(X).</div>
        </div>

        <div class="card">
          <h2>Hipótesis B — queda 1 especie</h2>
          <div class="kvs">
            <div class="key">P(1) = (W−1)/(W^{M+1}−1)</div><div id="res-P1">—</div>
            <div class="key">P'(X₀) = (1−P(1))^N</div><div id="res-PX1">—</div>
            <div class="key">X predicho</div><div id="res-X1">—</div>
            <div class="key">Ejemplares suplementarios</div><div id="res-extraB">—</div>
            <div class="key">Decisión</div><div id="res-decisionB" class="pill">—</div>
          </div>
          <div class="foot">Rechaza H2 si P'(X₀) ≤ P(X).</div>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h2>Gráfico del ajuste ln(x) vs i</h2>
        <div id="plot"></div>
        <div class="foot">Puntos: ln(frecuencia) por especie; línea: regresión <code>ln(x) = a + b·i</code>.</div>
      </div>

      <p class="foot">Notas: Usa logaritmo neperiano. Si W ≤ 1, el ajuste exponencial no es válido. Las fórmulas siguen el documento “muestreo-faunistico.md”.</p>
    </div>
  </body>
  </html>
